generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  STAFF
  AUDITOR
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  password      String
  role          Role     @default(STAFF)
  department    String?
  contactInfo   String?
  profileImage  String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assignedTasks     Task[]          @relation("AssignedTasks")
  createdTasks      Task[]          @relation("CreatedTasks")
  transactions      Transaction[]
  performances      Performance[]
  auditLogs         AuditLog[]
  reports           Report[]
  notifications     Notification[]
  createdProjects   Project[]       @relation("CreatedProjects")
  sessions          Session[]

  @@index([email])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionToken String   @unique
  expires      DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([sessionToken])
}

model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  budget      Float     @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  projects Project[]

  @@index([name])
}

model Project {
  id           String        @id @default(cuid())
  title        String
  description  String?
  startDate    DateTime
  endDate      DateTime?
  status       ProjectStatus @default(PLANNING)
  budget       Float         @default(0)
  spentAmount  Float         @default(0)
  departmentId String?
  createdById  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  department   Department?    @relation(fields: [departmentId], references: [id])
  createdBy    User           @relation("CreatedProjects", fields: [createdById], references: [id])
  tasks        Task[]
  transactions Transaction[]

  @@index([status])
  @@index([departmentId])
  @@index([createdById])
}

model Task {
  id          String       @id @default(cuid())
  projectId   String
  assignedTo  String
  createdBy   String
  title       String
  description String?
  deadline    DateTime
  progress    Int          @default(0)
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  project        Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedUser   User    @relation("AssignedTasks", fields: [assignedTo], references: [id])
  createdByUser  User    @relation("CreatedTasks", fields: [createdBy], references: [id])

  @@index([projectId])
  @@index([assignedTo])
  @@index([status])
  @@index([deadline])
}

model Transaction {
  id              String          @id @default(cuid())
  amount          Float
  type            TransactionType
  category        String
  date            DateTime
  description     String?
  projectId       String?
  addedBy         String
  receiptUrl      String?
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  project    Project? @relation(fields: [projectId], references: [id])
  user       User     @relation(fields: [addedBy], references: [id])

  @@index([projectId])
  @@index([addedBy])
  @@index([type])
  @@index([date])
}

model Performance {
  id          String   @id @default(cuid())
  userId      String
  goal        String
  score       Float
  period      String
  remarks     String?
  evaluatedBy String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([period])
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String
  action       String
  tableName    String
  recordId     String
  previousData Json?
  newData      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tableName])
  @@index([recordId])
  @@index([createdAt])
}

model Report {
  id          String   @id @default(cuid())
  title       String
  type        String
  generatedBy String
  filePath    String?
  fileUrl     String?
  metadata    Json?
  createdAt   DateTime @default(now())

  user User @relation(fields: [generatedBy], references: [id])

  @@index([generatedBy])
  @@index([type])
  @@index([createdAt])
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  message   String
  type      String
  status    NotificationStatus @default(UNREAD)
  metadata  Json?
  createdAt DateTime           @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
